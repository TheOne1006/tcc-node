<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Home</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Home</h1>

    



    


    <h3> </h3>










    




    <section>
        <article><p>TCC 型事务 node 实现, 该项目为我在项目中需要, 处理商城与应用之间的资金处理所做。</p>
<h2>基础</h2>
<blockquote>
<p>TCC事务机制简介</p>
</blockquote>
<ul>
<li>Try: 尝试执行业务
<ul>
<li>完成所有业务检查（一致性）</li>
<li>预留必须业务资源（准隔离性）</li>
</ul>
</li>
<li>Confirm: 确认执行业务
<ul>
<li>真正执行业务</li>
<li>只使用Try阶段预留的业务资源</li>
<li>Confirm操作满足幂等性</li>
</ul>
</li>
<li>Cancel: 取消执行业务
<ul>
<li>释放Try阶段预留的业务资源</li>
<li>Cancel操作满足幂等性</li>
</ul>
</li>
</ul>
<blockquote>
<p>业务逻辑</p>
</blockquote>
<ol>
<li>创建 <code>项目(project)</code>, <code>进程(process)</code>, <code>行为(action)</code> 这些基础配置</li>
<li>通过结果创建 <code>事务实例(TransactionInstance)</code></li>
<li>将初始状态的实例加入执行队列</li>
<li>一次执行实例对应的 tryAction</li>
<li>如果某个 tryAction 超过设置的失败次数, 将执行 cancelAction</li>
<li>如果所有的 tryAction 都成功执行, 将继续执行 confirmAction</li>
<li>如果 confirmAction 超过执行次数都没有成功, 将执行 cancelAction</li>
<li>如果 confirmAction/cancelAction 超过一定次数都没有执行成功, 则实例状态将标记为异常，需要人工干涉</li>
</ol>
<h2>Model 模型介绍</h2>
<p>详见:<a href="./model.html">模型</a></p>
<h2>技术栈</h2>
<ol>
<li>thrift: <a href="http:%5C/%5C/thrift.apache.org/tutorial/nodejs">http://thrift.apache.org/tutorial/nodejs</a></li>
<li>rpc</li>
<li>redis</li>
<li>bull-queue</li>
<li>log4js</li>
</ol>
<h2>本地测试</h2>
<p>测试基于 redis, 和 mysql, 先修改 <code>config.test.js</code> 相关配置</p>
<pre class="prettyprint source lang-bash"><code>npm run install
npm run test
</code></pre>
<h2>线上部署</h2>
<ol>
<li><code>pm2.json</code> 配置 pm2 实例数量</li>
<li><code>rpc-server</code> rpc 的服务</li>
<li><code>http-server</code> http 服务</li>
<li><code>schedule</code> 定时任务</li>
<li><code>queue</code> 队列任务</li>
</ol>
<h2>支持</h2>
<ul>
<li>rpc/http 调用方式</li>
</ul>
<h2>如何使用 thrift</h2>
<h3>step 1. 生成文件</h3>
<p>修改 <code>thriftExport/idl/tcc.thrift</code> 文件, 修改你需要的命名空间</p>
<pre class="prettyprint source lang-bash"><code># 根据语言 执行编译命令
thrift --out ./thriftExport/thrift_php_gen --gen php thriftExport/idl/tcc.thrift
# 在 thriftExport/thrift_php_gen 目录下生成相应的文件
</code></pre>
<h3>step 2.将编译文件加入项目</h3>
<p>将编译文件移动到项目中的目录(具体情况请参考各自语言)</p>
<h3>step 3.编写具体代码</h3>
<pre class="prettyprint source lang-php"><code>use App\Library\Thrift\Tcc\TranTccClient;
use Thrift\Protocol\TBinaryProtocol;
use Thrift\Protocol\TJSONProtocol;
use Thrift\Protocol\TMultiplexedProtocol;
use Thrift\Transport\TBufferedTransport;
use Thrift\Transport\TSocket;

/**
 * 这里使用的是 socket 链接
 */
try {
    // 创建 socket 实例
    $socket = new TSocket($this->config['host'], $this->config['port']);
    $socket->setRecvTimeout(50000);
    $socket->setDebug(true);

    // 创建客户端访问实例
    $transport = new TBufferedTransport($socket);
    $protocol = new TJSONProtocol($transport);
    $client = new TranTccClient($protocol);
    $transport->open();

    /**
     * 参数参考 thriftExport/idl/tcc.thrift
     */
    $params = [
      'projectKey',
      'processKey',
      'order_id',
      [
        'userId' => 12,
        'momeny' => 300,
      ]
    ];

    $result = $client->createInstance($params);
    $transport->close();
    return $result;
} catch (\TException $Te) {
  throw $Te->getMessage();
}
</code></pre></article>
    </section>






</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="model.html">model</a></li><li><a href="model.Action.html">Action</a></li><li><a href="model.ActionLog.html">ActionLog</a></li><li><a href="model.Process.html">Process</a></li><li><a href="model.Project.html">Project</a></li><li><a href="model.TransactionInstance.html">TransactionInstance</a></li></ul><h3>Classes</h3><ul><li><a href="Action.html">Action</a></li><li><a href="ActionLog.html">ActionLog</a></li><li><a href="BaseModel.html">BaseModel</a></li><li><a href="BullSystemQueue.html">BullSystemQueue</a></li><li><a href="Process.html">Process</a></li><li><a href="ProcessJob.html">ProcessJob</a></li><li><a href="Project.html">Project</a></li><li><a href="TransactionInstance.html">TransactionInstance</a></li><li><a href="TranTcc.html">TranTcc</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DEFAULT_MAX_ATTEMPT_TIME">DEFAULT_MAX_ATTEMPT_TIME</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Nov 17 2019 21:09:57 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>